# MCP Protocol Specification

**Protocol**: Model Context Protocol (MCP)
**Version**: 2024-11-05
**Transport**: stdio (JSON-RPC 2.0) / SSE (HTTP Server-Sent Events)

---

## Overview

MCP (Model Context Protocol) defines how AgentX communicates with tool providers.
This document specifies the subset of MCP features implemented in AgentX runtime.

**Supported Features**:
- ✅ Tools (discovery + execution)
- ✅ Resources (read-only access)
- ✅ Prompts (template system)
- ❌ Sampling (not implemented)
- ❌ Roots (not implemented)

---

## Transport Layers

### 1. Stdio Transport

JSON-RPC 2.0 messages over stdin/stdout for subprocess-based MCP servers.

**Server Lifecycle**:
```bash
# Start server process
$ /path/to/mcp-server-filesystem --root /workspace

# Server writes to stdout
<- {"jsonrpc": "2.0", "id": 1, "method": "initialize", ...}

# Client writes to stdin
-> {"jsonrpc": "2.0", "id": 1, "result": {...}}
```

**Message Format**:
- Each message is a single line (newline-delimited JSON)
- Request: `{"jsonrpc": "2.0", "id": <int>, "method": "<string>", "params": {...}}`
- Response: `{"jsonrpc": "2.0", "id": <int>, "result": {...}}` or `{"error": {...}}`
- Notification: `{"jsonrpc": "2.0", "method": "<string>", "params": {...}}` (no id)

**Process Management**:
- Server process launched on demand
- Graceful shutdown via `shutdown` method
- Auto-restart on crash (up to 3 attempts)
- Kill process if unresponsive after 5s

---

### 2. SSE Transport

HTTP Server-Sent Events for remote/network-based MCP servers.

**Connection**:
```
GET /sse HTTP/1.1
Host: localhost:3000
Accept: text/event-stream

<- event: endpoint
<- data: http://localhost:3000/message

<- event: message
<- data: {"jsonrpc": "2.0", "method": "tools/list", ...}
```

**Client → Server** (HTTP POST):
```
POST /message HTTP/1.1
Content-Type: application/json

{"jsonrpc": "2.0", "id": 1, "method": "tools/call", "params": {...}}
```

**Server → Client** (SSE events):
```
event: message
data: {"jsonrpc": "2.0", "id": 1, "result": {...}}
```

---

## Protocol Methods

### Initialization Handshake

**Client → Server** (initialize):
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "initialize",
  "params": {
    "protocolVersion": "2024-11-05",
    "capabilities": {
      "tools": {}
    },
    "clientInfo": {
      "name": "ComfyUI-AgentX",
      "version": "1.0.0"
    }
  }
}
```

**Server → Client** (initialize result):
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "protocolVersion": "2024-11-05",
    "capabilities": {
      "tools": {
        "listChanged": true
      },
      "resources": {
        "subscribe": false,
        "listChanged": false
      },
      "prompts": {
        "listChanged": false
      }
    },
    "serverInfo": {
      "name": "filesystem-server",
      "version": "1.0.0"
    }
  }
}
```

**Client → Server** (initialized notification):
```json
{
  "jsonrpc": "2.0",
  "method": "notifications/initialized"
}
```

---

### Tools

#### tools/list

**Request**:
```json
{
  "jsonrpc": "2.0",
  "id": 2,
  "method": "tools/list",
  "params": {
    "cursor": null
  }
}
```

**Response**:
```json
{
  "jsonrpc": "2.0",
  "id": 2,
  "result": {
    "tools": [
      {
        "name": "read_file",
        "description": "Read contents of a file",
        "inputSchema": {
          "type": "object",
          "properties": {
            "path": {
              "type": "string",
              "description": "File path to read"
            }
          },
          "required": ["path"]
        }
      },
      {
        "name": "write_file",
        "description": "Write contents to a file",
        "inputSchema": {
          "type": "object",
          "properties": {
            "path": {"type": "string"},
            "content": {"type": "string"}
          },
          "required": ["path", "content"]
        }
      }
    ],
    "nextCursor": null
  }
}
```

**Schema**:
```typescript
interface Tool {
  name: string;                    // Unique tool identifier
  description: string;              // Human-readable description
  inputSchema: JSONSchema;          // JSON Schema for arguments
}

interface ToolsListResult {
  tools: Tool[];
  nextCursor?: string;              // For pagination (optional)
}
```

---

#### tools/call

**Request**:
```json
{
  "jsonrpc": "2.0",
  "id": 3,
  "method": "tools/call",
  "params": {
    "name": "read_file",
    "arguments": {
      "path": "/workspace/config.json"
    }
  }
}
```

**Response** (success):
```json
{
  "jsonrpc": "2.0",
  "id": 3,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "{\"version\": \"1.0\", \"settings\": {...}}"
      }
    ],
    "isError": false
  }
}
```

**Response** (error):
```json
{
  "jsonrpc": "2.0",
  "id": 3,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "File not found: /workspace/config.json"
      }
    ],
    "isError": true
  }
}
```

**Schema**:
```typescript
interface ToolCallRequest {
  name: string;
  arguments: Record<string, unknown>;
}

interface ToolCallResult {
  content: Array<{
    type: "text" | "image" | "resource";
    text?: string;
    data?: string;           // Base64 for images
    uri?: string;            // For resources
    mimeType?: string;
  }>;
  isError?: boolean;
}
```

---

### Resources

#### resources/list

**Request**:
```json
{
  "jsonrpc": "2.0",
  "id": 4,
  "method": "resources/list",
  "params": {
    "cursor": null
  }
}
```

**Response**:
```json
{
  "jsonrpc": "2.0",
  "id": 4,
  "result": {
    "resources": [
      {
        "uri": "file:///workspace/README.md",
        "name": "README",
        "description": "Project documentation",
        "mimeType": "text/markdown"
      }
    ],
    "nextCursor": null
  }
}
```

---

#### resources/read

**Request**:
```json
{
  "jsonrpc": "2.0",
  "id": 5,
  "method": "resources/read",
  "params": {
    "uri": "file:///workspace/README.md"
  }
}
```

**Response**:
```json
{
  "jsonrpc": "2.0",
  "id": 5,
  "result": {
    "contents": [
      {
        "uri": "file:///workspace/README.md",
        "mimeType": "text/markdown",
        "text": "# Project Title\n\n..."
      }
    ]
  }
}
```

---

### Prompts

#### prompts/list

**Request**:
```json
{
  "jsonrpc": "2.0",
  "id": 6,
  "method": "prompts/list",
  "params": {
    "cursor": null
  }
}
```

**Response**:
```json
{
  "jsonrpc": "2.0",
  "id": 6,
  "result": {
    "prompts": [
      {
        "name": "debug_workflow",
        "description": "Debug a broken ComfyUI workflow",
        "arguments": [
          {
            "name": "workflow_json",
            "description": "Workflow JSON to debug",
            "required": true
          }
        ]
      }
    ],
    "nextCursor": null
  }
}
```

---

#### prompts/get

**Request**:
```json
{
  "jsonrpc": "2.0",
  "id": 7,
  "method": "prompts/get",
  "params": {
    "name": "debug_workflow",
    "arguments": {
      "workflow_json": "{...}"
    }
  }
}
```

**Response**:
```json
{
  "jsonrpc": "2.0",
  "id": 7,
  "result": {
    "description": "Debug workflow template",
    "messages": [
      {
        "role": "user",
        "content": {
          "type": "text",
          "text": "Please analyze this workflow and identify errors:\n\n{workflow_json}"
        }
      }
    ]
  }
}
```

---

### Notifications

#### notifications/tools/list_changed

Server notifies client when tool list changes (e.g., dynamic tool registration).

**Server → Client**:
```json
{
  "jsonrpc": "2.0",
  "method": "notifications/tools/list_changed"
}
```

**Client Action**: Re-call `tools/list` to refresh tool registry.

---

## Error Handling

### JSON-RPC Errors

Standard JSON-RPC 2.0 error codes:

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "error": {
    "code": -32600,
    "message": "Invalid Request",
    "data": {
      "details": "Missing required parameter: name"
    }
  }
}
```

**Error Codes**:
- `-32700`: Parse error (invalid JSON)
- `-32600`: Invalid Request
- `-32601`: Method not found
- `-32602`: Invalid params
- `-32603`: Internal error
- `-32000` to `-32099`: Server-defined errors

### Tool Execution Errors

Tool failures are returned as successful JSON-RPC responses with `isError: true`:

```json
{
  "jsonrpc": "2.0",
  "id": 3,
  "result": {
    "content": [{"type": "text", "text": "Permission denied"}],
    "isError": true
  }
}
```

**AgentX Handling**:
1. Log error to AgentX event system (StateEvent with state=error)
2. Pass error text to Claude as tool_result
3. Allow Claude to decide retry strategy

---

## Server Configuration

### Stdio Server Config

```json
{
  "name": "filesystem",
  "type": "stdio",
  "command": "/usr/local/bin/mcp-server-filesystem",
  "args": ["--root", "/workspace"],
  "env": {
    "LOG_LEVEL": "info"
  }
}
```

### SSE Server Config

```json
{
  "name": "remote-tools",
  "type": "sse",
  "url": "http://localhost:3000/sse"
}
```

---

## AgentX Integration

### Tool Discovery Flow

```
1. AgentX starts
   ↓
2. For each configured MCP server:
   a. Launch process (stdio) or connect (SSE)
   b. Send initialize request
   c. Wait for initialize response
   d. Send initialized notification
   e. Call tools/list
   f. Register tools in AgentEngine
   ↓
3. Convert MCP tools to Claude format:
   mcp_tool.inputSchema → claude_tool.input_schema
   ↓
4. Tools ready for Claude API
```

### Tool Execution Flow

```
1. Claude requests tool via API:
   {"name": "read_file", "input": {"path": "..."}}
   ↓
2. AgentEngine routes to correct MCP server
   ↓
3. MCP client calls tools/call via JSON-RPC
   ↓
4. MCP server executes tool
   ↓
5. Result returned to AgentEngine
   ↓
6. AgentEngine emits StateEvent (tool_result)
   ↓
7. Result passed back to Claude API
```

---

## Implementation Notes

### AgentX-Specific Behavior

1. **Tool Naming Conflicts**: If multiple servers provide same tool name, prefix with server name:
   - `read_file` (from filesystem server)
   - `comfyui.read_file` (from comfyui server, if conflict exists)

2. **Timeout Handling**:
   - stdio tool calls: 120s timeout
   - SSE tool calls: 120s timeout
   - Server initialization: 30s timeout

3. **Retry Logic**:
   - Server crashes: auto-restart up to 3 times
   - Tool call failures: no automatic retry (Claude decides)

4. **Logging**:
   - All MCP messages logged at DEBUG level
   - Tool calls logged at INFO level
   - Errors logged at ERROR level

---

## Testing Strategy

### Unit Tests
- JSON-RPC message serialization/deserialization
- Tool schema validation (JSON Schema)
- Error handling (invalid params, server crash)

### Integration Tests
- Full stdio server lifecycle (start, call, stop)
- SSE server connection and streaming
- Tool discovery and registration
- Concurrent tool calls across multiple servers

### Contract Tests
- Validate against official MCP test suite
- Test with real MCP servers (filesystem, fetch, etc.)

---

## References

- [MCP Specification](https://github.com/anthropics/mcp)
- [JSON-RPC 2.0](https://www.jsonrpc.org/specification)
- [JSON Schema](https://json-schema.org/)
- [fastmcp Documentation](https://github.com/jlowin/fastmcp)

---

**Status**: Phase 1 Design Complete
**Date**: 2026-01-02
